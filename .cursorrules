# üêª Teddy Shop - AI Coding Rules & Guidelines

**Project:** Teddy Shop E-commerce Platform  
**Purpose:** Ensure code quality, consistency, and production readiness  
**Enforcement:** AI must follow these rules strictly

---

## üìã Table of Contents

1. [Project Context](#1-project-context)
2. [Core Principles](#2-core-principles)
3. [Documentation Enforcement](#3-documentation-enforcement-mandatory)
4. [QA & Safety Protocols](#4-qa--safety-protocols)
5. [Architecture & Directory](#5-architecture--directory-structure)
6. [Coding Standards](#6-coding-standards)
7. [File Naming & Case Sensitivity](#7-file-naming--case-sensitivity-critical---dec-2025)
8. [Specific Features](#8-specific-feature-guidelines)
9. [Testing & Quality](#9-testing--quality)
10. [Git Protocols](#10-git--project-management-protocols)

---

## 1. Project Context

### üè∑Ô∏è Basic Info

| Property       | Value                                 |
| -------------- | ------------------------------------- |
| **Name**       | Teddy Shop E-commerce Platform        |
| **Framework**  | Next.js 16 (App Router)               |
| **Frontend**   | React 19, TypeScript 5                |
| **Database**   | MongoDB (Native Driver)               |
| **Auth**       | NextAuth v5                           |
| **Styling**    | Tailwind CSS, Radix UI, Lucide Icons  |
| **State**      | Zustand, React Hook Form              |
| **Blog**       | Tiptap, date-fns                      |
| **Validation** | Zod (Zod schemas)                     |
| **Editor**     | Tiptap (Rich text)                    |
| **Security**   | Cloudflare Turnstile (CAPTCHA)        |
| **Anti-spam**  | Spam detection utils (keywords/links) |

### üéØ Key Features

- Author Management (E-E-A-T compliance)
- Blog System with Tiptap editor, templates, product linking, reading time, table of contents
- Comment System with spam detection, CAPTCHA (Cloudflare Turnstile), and admin moderation
- Social Share Buttons ƒëa k√™nh cho Blog (Facebook, Zalo, Copy link, Clipboard API)
- Product Management
- SEO Tools (Keywords, Schema.org, Audit)
- Homepage Configuration System (15 sections)
- **Tiptap Editor Enhancements (Dec 2025):** Custom keyboard shortcuts (Ctrl+K for Link, Ctrl+U for Underline), WordPress-style toolbar with comprehensive formatting tools, Image editing with bubble menu and modal dialog
  **Tech Stack Additions (Dec 2025):** Zod, Tiptap editor suite, Cloudflare Turnstile (CAPTCHA)

---

## 2. Core Principles

### üéØ The Six Pillars:

#### 1Ô∏è‚É£ Server-Side First

```
Prioritize Server Components by default.
Use 'use client' ONLY when absolutely needed:
  ‚úÖ When: useState, useEffect, event handlers, useRouter, useSession
  ‚ùå When: Just rendering static content
  ‚ùå When: Only using window.location.href (use Link instead)

AUDIT RULE (Dec 2025):
  - 100% of pages must justify 'use client' usage
  - If no React hooks used ‚Üí Must be Server Component
  - Replace window.location.href with Next.js Link
```

#### 2Ô∏è‚É£ Clean Architecture

```
Separation of Concerns:
  üìÑ UI components    ‚Üí src/components/
  üß† Business logic   ‚Üí src/lib/
  üóÑÔ∏è Data access      ‚Üí src/lib/db.ts
  ‚úÖ Validation       ‚Üí src/lib/schemas/
  üîß Utility functions ‚Üí src/lib/utils/

UTILITY EXTRACTION RULE (Dec 2025):
  - Pure functions (no React hooks) ‚Üí src/lib/utils/
  - Examples: slug.ts, format.ts
  - Never inline formatDate, generateSlug, etc.
  - Reuse centralized utilities
```

#### 3Ô∏è‚É£ Strict TypeScript

```
‚ùå FORBIDDEN: any type
‚úÖ REQUIRED: Always define or import interfaces
‚úÖ USE: unknown for uncertain types
‚úÖ DEFINE: Proper interfaces for all data
```

#### 4Ô∏è‚É£ Security First

```
‚úÖ Validate ALL inputs with Zod
‚úÖ Check auth/roles on EVERY protected route
‚úÖ Never trust client data
‚úÖ Always recalculate prices server-side
```

#### 5Ô∏è‚É£ Performance Optimization

```
BUNDLE SIZE RULES (Dec 2025):
  ‚úÖ Use dynamic imports for heavy libraries (>50KB)
  ‚úÖ Examples: Recharts, Tiptap, Framer Motion
  ‚úÖ Show loading skeletons
  ‚úÖ Set ssr: false for client-only libraries

PATTERN:
  const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
    loading: () => <Skeleton />,
    ssr: false,
  });

TARGET: Keep initial bundle < 250KB
```

#### 6Ô∏è‚É£ Full Implementation Protocol

```
‚ùå FORBIDDEN Phrases: "You need to...", "Here is an example...", "Modify the file like this..."

‚úÖ REQUIRED Action: "Here is the updated file:", "I have fixed the issue. Here is the code:"

- Always output actionable, copy-pasteable, COMPLETE code.
- Do not shift the burden of implementation to the user.
```

---

## 3. Documentation Enforcement (MANDATORY)

### üö® CRITICAL RULE:

When performing tasks, AI **MUST** automatically load these documents:

| Task Type                               | Required Document     | Purpose                       |
| --------------------------------------- | --------------------- | ----------------------------- |
| **DB Queries, Schemas, API validation** | `@DATABASE_SCHEMA.md` | Verify fields, types, indexes |
| **Complex business logic**              | `@FLOW.md`            | Follow sequential steps       |
| **Everything else**                     | `@CONTEXT.md`         | Core business rules           |

### üìñ Document Priority:

**Before creating/modifying data:**

1. ‚úÖ Read `DATABASE_SCHEMA.md` ‚Üí Check schema, field names, indexes
2. ‚úÖ Use correct field types
3. ‚úÖ Follow existing constraints

**Before implementing checkout/order logic:**

1. ‚úÖ Read `FLOW.md` ‚Üí Follow defined flow
2. ‚úÖ Implement rollback strategies
3. ‚úÖ Follow state transitions

**Always:**

- ‚úÖ Reference `@CONTEXT.md` for architecture decisions
- ‚úÖ Follow patterns defined in documentation

---

## 4. QA & Safety Protocols

### üõ°Ô∏è Zero-Tolerance Linter Rules

#### ‚ùå Rule 1: No Unused Variables

```typescript
// ‚ùå WRONG: Unused import
import { UserIcon, HomeIcon } from 'lucide-react';
export function Header() {
  return <UserIcon />; // HomeIcon not used!
}

// ‚úÖ CORRECT: Remove unused
import { UserIcon } from 'lucide-react';
export function Header() {
  return <UserIcon />;
}
```

**Action:** Remove ALL unused variables/imports during refactoring

---

#### ‚ùå Rule 2: No 'any' Type

```typescript
// ‚ùå STRICTLY FORBIDDEN
function processData(data: any) {
  return data.something;
}

// ‚úÖ CORRECT: Define proper interface
interface User {
  id: string;
  name: string;
}

function processData(data: User) {
  return data.name;
}

// ‚úÖ ACCEPTABLE: Use unknown for uncertain types
function processData(data: unknown) {
  if (typeof data === 'object' && data !== null) {
    // Type guard
  }
}
```

**Rule:** NEVER use `any`. Use `unknown` or define interface.

---

#### ‚ùå Rule 3: Exhaustive Dependencies

```typescript
// ‚ùå WRONG: Missing dependency
useEffect(() => {
  fetchData(userId);
}, []); // userId not in deps!

// ‚úÖ CORRECT: Include all deps
useEffect(() => {
  fetchData(userId);
}, [userId]);

// ‚ùå NEVER suppress warnings
useEffect(() => {
  fetchData(userId);
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, []); // BAD PRACTICE!
```

**Rule:** Always include ALL variables used inside hooks in dependency array.

---

#### ‚ùå Rule 4: No Console Logs

```typescript
// ‚ùå WRONG: Leave console.log
export function Component() {
  console.log('Debug info');
  return <div>Hello</div>;
}

// ‚úÖ CORRECT: Remove or use proper logging
export function Component() {
  // console.log removed
  return <div>Hello</div>;
}

// ‚úÖ ACCEPTABLE: Proper error logging
try {
  // ...
} catch (error) {
  console.error('Critical error:', error); // OK for errors
}
```

**Rule:** No `console.log` in production code. Use proper error logging if needed.

---

### üèóÔ∏è Build Safety (Server vs Client)

#### Import Guards

```typescript
// ‚ùå WRONG: Import server code in client component
'use client';

import { getCollections } from '@/lib/db'; // Server-only!

export function ClientComponent() {
  // This will fail!
}

// ‚úÖ CORRECT: Call API instead
('use client');

export function ClientComponent() {
  useEffect(() => {
    fetch('/api/data').then((r) => r.json());
  }, []);
}
```

**Rule:** NEVER import server-only code (db.ts, env secrets) in 'use client' files.

---

#### Environment Variables in Build Phase (CRITICAL - Dec 2025)

**Problem:** Next.js build phase (especially on Vercel) may not have access to environment variables. Code that validates env vars at module import time will fail during build.

**Rule:** Environment variables MUST be validated at runtime, not at module import time.

```typescript
// ‚ùå WRONG: Validate at import time
// src/lib/auth.ts
if (!process.env.AUTH_SECRET) {
  throw new Error('AUTH_SECRET is required'); // ‚ùå Fails during build!
}

export const auth = NextAuth({
  secret: process.env.AUTH_SECRET, // May be undefined during build
});

// ‚úÖ CORRECT: Validate at runtime with build phase detection
// src/lib/auth.ts
const getAuthSecret = (): string => {
  if (process.env.AUTH_SECRET) {
    return process.env.AUTH_SECRET;
  }

  // Detect build phase
  const isBuildPhase =
    process.env.NEXT_PHASE === 'phase-production-build' ||
    process.env.VERCEL === '1' ||
    process.env.CI === 'true' ||
    (typeof process.env.NODE_ENV === 'undefined' && !process.env.AUTH_SECRET);

  if (isBuildPhase) {
    // Return temporary valid secret during build
    // Vercel will inject real secret at runtime
    return 'dGVtcF9idWlsZF9zZWNyZXRfcmVwbGFjZV9hdF9ydW50aW1lXzEyMzQ1Njc4OTA=';
  }

  // In development, throw to catch missing config early
  throw new Error('AUTH_SECRET is required. Generate with: openssl rand -base64 32');
};

export const auth = NextAuth({
  secret: getAuthSecret(), // Safe during build, validated at runtime
});
```

**Build Phase Detection:**

```typescript
// Detect if we're in build phase
const isBuildPhase =
  process.env.NEXT_PHASE === 'phase-production-build' || // Next.js build
  process.env.VERCEL === '1' || // Vercel build
  process.env.CI === 'true' || // CI/CD environment
  (typeof process.env.NODE_ENV === 'undefined' && !process.env.AUTH_SECRET); // Fallback
```

**Pattern for Env Var Validation:**

```typescript
// ‚úÖ CORRECT: Lazy validation function
const getRequiredEnv = (key: string, defaultValue?: string): string => {
  const value = process.env[key];

  if (value) {
    return value;
  }

  // During build, return placeholder if default provided
  const isBuildPhase =
    process.env.NEXT_PHASE === 'phase-production-build' ||
    process.env.VERCEL === '1' ||
    process.env.CI === 'true';

  if (isBuildPhase && defaultValue) {
    return defaultValue; // Temporary placeholder
  }

  // In development/runtime, throw if missing
  throw new Error(`${key} is required. Set it in .env.local or environment variables.`);
};

// Usage
const dbUri = getRequiredEnv('MONGODB_URI');
const authSecret = getRequiredEnv('AUTH_SECRET', 'temp_build_secret');
```

**When to Apply:**

- ‚úÖ NextAuth secret configuration
- ‚úÖ Database connection strings
- ‚úÖ API keys used in server-side code
- ‚úÖ Any env var validated at module level

**When NOT to Apply:**

- ‚ùå Client-side env vars (`NEXT_PUBLIC_*`) - available during build
- ‚ùå Runtime-only validation (inside API routes) - safe to validate immediately
- ‚ùå Optional env vars - can use `process.env.VAR || 'default'`

**Vercel-Specific Notes:**

- Vercel injects env vars at runtime, not build time
- Build phase uses placeholder values
- Runtime phase uses actual env vars from Vercel dashboard
- Always configure env vars in Vercel project settings

**Benefits:**

- ‚úÖ Build succeeds on Vercel/CI
- ‚úÖ Runtime validation catches missing config
- ‚úÖ Development fails fast with clear error messages
- ‚úÖ No breaking changes to existing code

---

#### Type Imports

```typescript
// ‚úÖ CORRECT: Use 'import type' for types only
import type { User } from '@/lib/types/user';
import { formatUser } from '@/lib/utils/user';

// ‚ùå AVOID: Regular import for types
import { User } from '@/lib/types/user'; // May cause side effects
```

**Rule:** Use `import type { }` when importing interfaces/types only.

---

#### Image Optimization

```typescript
// ‚ùå WRONG: Standard img tag
<img src="/photo.jpg" />;

// ‚úÖ CORRECT: Next.js Image component
import Image from 'next/image';

<Image
  src="/photo.jpg"
  alt="Product photo" // Alt REQUIRED
  width={500}
  height={300}
/>;
```

**Rules:**

- ‚úÖ ALWAYS use `next/image`
- ‚úÖ ALWAYS provide meaningful `alt` prop
- ‚ùå NEVER use `<img>` tag (unless raw HTML)

---

## 5. Architecture & Directory Structure

```
src/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (shop)/              # üõçÔ∏è Public pages (with Header/Footer)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx         # Homepage (dynamic from config)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/        # Product listing & detail
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/            # Shopping cart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout/        # Checkout process
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (content)/       # Blog, About, Store
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ admin/               # üîí Protected admin (Sidebar only)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authors/         # Author CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts/           # Blog CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/        # Product CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ homepage/        # Homepage config
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ seo/             # SEO tools
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/        # System settings
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ api/                 # üîå API Routes (Route Handlers)
‚îÇ       ‚îú‚îÄ‚îÄ admin/           # Admin-only endpoints
‚îÇ       ‚îú‚îÄ‚îÄ authors/         # Public author API
‚îÇ       ‚îú‚îÄ‚îÄ homepage/        # Public homepage API
‚îÇ       ‚îî‚îÄ‚îÄ checkout/        # Checkout API
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                  # ‚öõÔ∏è Atomic components (Shadcn style)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ button.tsx       # Reuse these!
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ table.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (11 total)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ admin/               # üõ†Ô∏è Admin widgets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthorBoxWidget.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RowActions.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ homepage/        # Homepage builder
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ blog/                # üìù Blog components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthorBox.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ReviewerBox.tsx
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ homepage/            # üè† Homepage sections
‚îÇ       ‚îú‚îÄ‚îÄ HomepageRenderer.tsx
‚îÇ       ‚îî‚îÄ‚îÄ sections/        # 15 section types
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ db.ts                # üóÑÔ∏è MongoDB connection
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts              # üîê NextAuth config
‚îÇ   ‚îú‚îÄ‚îÄ types/               # TypeScript interfaces
‚îÇ   ‚îú‚îÄ‚îÄ schemas/             # Zod validation
‚îÇ   ‚îú‚îÄ‚îÄ utils/               # üÜï Utility functions
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ slug.ts          # generateSlug(), isValidSlug()
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ format.ts        # formatDate(), formatCurrency()
‚îÇ   ‚îú‚îÄ‚îÄ payment/             # Payment gateways
‚îÇ   ‚îú‚îÄ‚îÄ stock/               # Stock management
‚îÇ   ‚îî‚îÄ‚îÄ email/               # Email service
‚îÇ
‚îî‚îÄ‚îÄ store/
    ‚îî‚îÄ‚îÄ useCartStore.ts      # Zustand cart state
```

### üìÅ Key Directories:

| Directory           | Purpose           | Pattern                      |
| ------------------- | ----------------- | ---------------------------- |
| `src/app/(shop)`    | Public pages      | Server Components preferred  |
| `src/app/admin`     | Admin dashboard   | Authentication required      |
| `src/app/api`       | REST endpoints    | Return NextResponse.json     |
| `src/components/ui` | Reusable UI       | Prefer reusing over creating |
| `src/lib`           | Business logic    | No React code                |
| `src/lib/schemas`   | Validation        | Zod schemas                  |
| `src/lib/utils`     | üÜï Pure functions | slug, format, etc.           |

---

## 6. Coding Standards

### 0Ô∏è‚É£ Tiptap Editor Extensions (NEW - Dec 2025)

**Custom Extensions Pattern:**

```typescript
// ‚úÖ CORRECT: Create custom extension for keyboard shortcuts
import { Extension } from '@tiptap/core';

export const KeyboardShortcuts = Extension.create({
  name: 'keyboardShortcuts',
  addKeyboardShortcuts() {
    return {
      'Mod-k': () => {
        // Prevent browser default
        if ((this.editor as any).__openLinkModal) {
          (this.editor as any).__openLinkModal();
          return true; // Consume event
        }
        return false;
      },
    };
  },
});
```

**Editor Storage Pattern:**

```typescript
// ‚úÖ CORRECT: Use editor storage for cross-component communication
useEffect(() => {
  (editor as any).__openLinkModal = () => {
    setShowLinkModal(true);
  };
  return () => {
    delete (editor as any).__openLinkModal;
  };
}, [editor]);
```

**Rules:**
- ‚úÖ Use `Extension.create()` for custom Tiptap extensions
- ‚úÖ Return `true` in keymap handler to consume event and prevent browser default
- ‚úÖ Use editor storage (`editor.__functionName`) for cross-component communication
- ‚úÖ Clean up editor storage in `useEffect` cleanup function
- ‚ùå Don't use global variables or React context for editor functions

---

### 1Ô∏è‚É£ Database Access (CRITICAL)

#### ‚úÖ CORRECT Pattern: Repository via getCollections()

```typescript
import { getCollections } from '@/lib/db';
import { ObjectId } from 'mongodb';

async function getUser(id: string) {
  // Step 1: Get collections
  const { users, posts } = await getCollections();

  // Step 2: Validate ID
  if (!ObjectId.isValid(id)) {
    throw new Error('Invalid ID');
  }

  // Step 3: Query with ObjectId
  const user = await users.findOne({
    _id: new ObjectId(id),
  });

  return user;
}
```

#### ‚ùå FORBIDDEN Patterns:

```typescript
// ‚ùå DON'T: Mongoose Models
const user = await User.findOne({ _id: id });

// ‚ùå DON'T: Prisma
const user = await prisma.user.findUnique({ where: { id } });

// ‚ùå DON'T: Query without ObjectId conversion
const user = await users.findOne({ _id: id }); // String won't work!
```

#### üîë ID Handling Rules:

```typescript
// Always validate before converting
if (!ObjectId.isValid(id)) {
  return NextResponse.json({ error: 'Invalid ID' }, { status: 400 });
}

// Then convert for query
const doc = await collection.findOne({
  _id: new ObjectId(id),
});
```

---

### 2Ô∏è‚É£ API Routes (Next.js Route Handlers)

#### Pattern:

```typescript
// Location: src/app/api/[feature]/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { getCollections } from '@/lib/db';
import { schemaName } from '@/lib/schemas/feature';

export async function GET(request: NextRequest) {
  try {
    // 1. Check authentication (if protected)
    const session = await auth();
    if (!session?.user || session.user.role !== 'admin') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 2. Get data
    const { collection } = await getCollections();
    const data = await collection.find({}).toArray();

    // 3. Return JSON
    return NextResponse.json({ data }, { status: 200 });
  } catch (error) {
    // 4. Error handling
    console.error('Error:', error);
    return NextResponse.json({ error: 'Failed to fetch data' }, { status: 500 });
  }
}

export async function POST(request: NextRequest) {
  try {
    // 1. Auth check
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 2. Parse body
    const body = await request.json();

    // 3. Validate with Zod
    const validatedData = schemaName.parse(body);

    // 4. Process & save
    const { collection } = await getCollections();
    const result = await collection.insertOne(validatedData);

    // 5. Return success
    return NextResponse.json(
      { message: 'Created successfully', id: result.insertedId },
      { status: 201 }
    );
  } catch (error) {
    if (error.name === 'ZodError') {
      return NextResponse.json({ error: 'Invalid data', details: error }, { status: 400 });
    }
    return NextResponse.json({ error: 'Server error' }, { status: 500 });
  }
}
```

#### Status Codes:

| Code | Meaning               | When to Use                 |
| ---- | --------------------- | --------------------------- |
| 200  | OK                    | Successful GET/PATCH        |
| 201  | Created               | Successful POST             |
| 400  | Bad Request           | Invalid input               |
| 401  | Unauthorized          | Not logged in               |
| 403  | Forbidden             | Logged in but no permission |
| 404  | Not Found             | Resource doesn't exist      |
| 500  | Internal Server Error | Server/DB error             |

---

#### üîí Standardized Error Responses (NEW - Dec 2025)

**Rule:** All API Routes MUST return errors in a strict JSON structure to prevent inconsistent error objects.

**Type Definition:**

```typescript
type APIErrorResponse = {
  success: false;
  error: {
    code: string; // e.g., 'VALIDATION_ERROR', 'AUTH_ERROR', 'NOT_FOUND'
    message: string; // Human-readable message
    details?: unknown; // Zod error details or additional context
  };
};

type APISuccessResponse<T> = {
  success: true;
  data: T;
  message?: string;
};
```

**Error Codes:**

| Code               | Status | Usage                  |
| ------------------ | ------ | ---------------------- |
| `VALIDATION_ERROR` | 400    | Zod validation failed  |
| `AUTH_ERROR`       | 401    | Not authenticated      |
| `FORBIDDEN`        | 403    | No permission          |
| `NOT_FOUND`        | 404    | Resource doesn't exist |
| `CONFLICT`         | 409    | Duplicate/conflict     |
| `SERVER_ERROR`     | 500    | Internal error         |

**Examples:**

```typescript
// ‚úÖ CORRECT: Validation error
return NextResponse.json(
  {
    success: false,
    error: {
      code: 'VALIDATION_ERROR',
      message: 'Invalid input data',
      details: error.flatten(),
    },
  },
  { status: 400 }
);

// ‚úÖ CORRECT: Authentication error
return NextResponse.json(
  {
    success: false,
    error: {
      code: 'AUTH_ERROR',
      message: 'Authentication required',
    },
  },
  { status: 401 }
);

// ‚úÖ CORRECT: Not found
return NextResponse.json(
  {
    success: false,
    error: {
      code: 'NOT_FOUND',
      message: 'Resource not found',
    },
  },
  { status: 404 }
);

// ‚úÖ CORRECT: Success response
return NextResponse.json(
  {
    success: true,
    data: { user },
    message: 'User created successfully',
  },
  { status: 201 }
);

// ‚ùå WRONG: Inconsistent error format
return NextResponse.json({ error: 'Something went wrong' }, { status: 500 });

// ‚ùå WRONG: No success field
return NextResponse.json({ data: user }, { status: 200 });
```

**Benefits:**

- ‚úÖ Consistent error handling across all API routes
- ‚úÖ Better client-side error detection (`if (!response.success)`)
- ‚úÖ Easier debugging with error codes
- ‚úÖ Type-safe error responses

---

### 3Ô∏è‚É£ Authentication & Authorization

```typescript
// Import auth
import { auth } from '@/lib/auth';

// Check at START of every protected route
export async function POST(request: NextRequest) {
  // Step 1: Get session
  const session = await auth();

  // Step 2: Check authentication
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Step 3: Check role (if admin-only)
  if (session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  // Proceed with logic...
}
```

**Rules:**

- ‚úÖ Check at the START of route
- ‚úÖ Check both user AND role
- ‚úÖ Return proper status codes

---

### 4Ô∏è‚É£ Component Implementation

#### Function Components (Preferred):

```typescript
// ‚úÖ CORRECT: Named export function
interface Props {
  name: string;
  age: number;
}

export function UserCard({ name, age }: Props) {
  return (
    <div>
      {name} - {age}
    </div>
  );
}

// ‚ùå AVOID: const with React.FC
export const UserCard: React.FC<Props> = ({ name, age }) => {
  return (
    <div>
      {name} - {age}
    </div>
  );
};
```

#### Props Interface:

```typescript
// ‚úÖ ALWAYS define props interface ABOVE component
interface ButtonProps {
  label: string;
  onClick: () => void;
  variant?: 'primary' | 'secondary';
}

export function Button({ label, onClick, variant = 'primary' }: ButtonProps) {
  // Component logic
}
```

#### Icons:

```typescript
// ‚úÖ Use lucide-react
import { UserIcon, ShoppingCart, Heart } from 'lucide-react';

<UserIcon className="w-5 h-5" />;
```

#### Styling:

```typescript
// ‚úÖ Tailwind classes via className
<div className="flex items-center gap-4 p-6 bg-white rounded-lg shadow-md">

// ‚úÖ Use cn() for conditional classes
import { cn } from '@/lib/utils';

<div className={cn(
  'base-class',
  isActive && 'active-class',
  variant === 'primary' && 'primary-class'
)}>
```

#### Form Decomposition (NEW - Dec 2025)

- B·∫•t k·ª≥ form >120 d√≤ng, ƒëa b∆∞·ªõc ho·∫∑c c√≥ >6 tr∆∞·ªùng ph·∫£i t√°ch th√†nh component con theo nh√≥m tr∆∞·ªùng/step v√† t√°ch logic submit ra hooks/service.
- Lu√¥n d√πng React Hook Form + Zod schema cho to√†n b·ªô validation; kh√¥ng inline validate ho·∫∑c setState r·ªùi r·∫°c.
- Quy tr√¨nh chu·∫©n: parse schema ‚Üí call service/API ‚Üí handle error/success v·ªõi toast/modal; tuy·ªát ƒë·ªëi kh√¥ng vi·∫øt business logic trong JSX.

---

#### Accessibility (A11y):

**Rule:** Icon-only buttons MUST have an `aria-label` for screen readers.

```typescript
// ‚ùå WRONG: Icon button without label
<Button size="icon">
  <TrashIcon />
</Button>

// ‚úÖ CORRECT: Accessible icon button
<Button size="icon" aria-label="Delete item">
  <TrashIcon />
</Button>

// ‚úÖ CORRECT: Icon with text (no aria-label needed)
<Button>
  <TrashIcon className="w-4 h-4 mr-2" />
  Delete
</Button>
```

**Additional A11y Rules:**

- ‚úÖ All images MUST have alt text
- ‚úÖ Form inputs MUST have labels
- ‚úÖ Interactive elements MUST be keyboard accessible
- ‚úÖ Color contrast MUST meet WCAG 2.1 AA standards

---

#### Component Props Flexibility (CRITICAL - Dec 2025)

**Problem:** Components used in multiple contexts (HomepageRenderer vs direct usage) may receive different prop structures.

**Rule:** Components that can be used both via HomepageRenderer and directly MUST support flexible props.

```typescript
// ‚ùå WRONG: Strict props only
interface SectionComponentProps<T> {
  section: Section;
  content: T;
  layout: Layout;
}

export function HeroSlider({ content }: SectionComponentProps<HeroSliderContent>) {
  // Only works with HomepageRenderer
}

// ‚úÖ CORRECT: Flexible props with union type
interface SectionComponentProps<T> {
  section: Section;
  content: T;
  layout: Layout;
}

export function HeroSlider({
  content,
  section, // Optional for direct usage
  layout, // Optional for direct usage
}: SectionComponentProps<HeroSliderContent> | { content: HeroSliderContent }) {
  // Extract content based on prop structure
  const sliderContent =
    'section' in arguments[0]
      ? (arguments[0] as SectionComponentProps<HeroSliderContent>).content
      : content;

  // Use sliderContent instead of content
  const slides = sliderContent.slides || [];
}
```

**Pattern for Flexible Components:**

```typescript
// 1. Define both prop types
type FullProps<T> = SectionComponentProps<T>;
type DirectProps<T> = { content: T };

// 2. Use union type in function signature
export function Component<T>(props: FullProps<T> | DirectProps<T>) {
  // 3. Extract content safely
  const content = 'section' in props ? props.content : props.content;

  // 4. Use content normally
  return <div>{content.title}</div>;
}
```

**When to Apply:**

- ‚úÖ Homepage section components (HeroSlider, FeaturedProducts, etc.)
- ‚úÖ Components used in both admin editor and public pages
- ‚úÖ Reusable components with different contexts

**When NOT to Apply:**

- ‚ùå Simple UI components (Button, Input) - keep strict props
- ‚ùå Internal-only components - no need for flexibility
- ‚ùå API-only components - single context

**Benefits:**

- ‚úÖ Single component works in multiple contexts
- ‚úÖ No duplicate component code
- ‚úÖ Type-safe with union types
- ‚úÖ Backward compatible with existing code

---

### 5Ô∏è‚É£ Utility Functions (NEW - Dec 2025)

#### Centralized Utilities:

**Location:** `src/lib/utils/`

**Pattern:**

```typescript
// ‚ùå WRONG: Inline utility in component
export function PostEditor() {
  const generateSlug = (text: string) => {
    return text.toLowerCase()...
  };
  // Component logic
}

// ‚úÖ CORRECT: Import from centralized utils
import { generateSlug } from '@/lib/utils/slug';

export function PostEditor() {
  // Component logic - just use generateSlug()
}
```

**Available Utilities:**

**A. Slug Generation (`src/lib/utils/slug.ts`):**

```typescript
import { generateSlug, isValidSlug } from '@/lib/utils/slug';

generateSlug('Hello World'); // ‚Üí 'hello-world'
isValidSlug('hello-world'); // ‚Üí true
```

**B. Formatting (`src/lib/utils/format.ts`):**

```typescript
import { formatDate, formatCurrency, formatFileSize } from '@/lib/utils/format';

formatDate(new Date()); // ‚Üí '04/12/2025 14:30'
formatCurrency(100000); // ‚Üí '100.000 ‚Ç´'
formatFileSize(1024); // ‚Üí '1 KB'
```

**Rule:** ALWAYS import utilities. NEVER duplicate logic.

---

### 6Ô∏è‚É£ Date & Time

```typescript
// ‚úÖ Use centralized format utility
import { formatDate } from '@/lib/utils/format';

formatDate(new Date()); // Vietnamese format
formatDate(date, 'en-US'); // Custom locale

// ‚úÖ Store as Date objects in MongoDB
const document = {
  createdAt: new Date(), // ‚úÖ Date object
  updatedAt: new Date(),
};

// ‚ùå NEVER store as strings
const document = {
  createdAt: '2025-12-04', // ‚ùå WRONG!
};
```

---

### 7Ô∏è‚É£ File Naming & Case Sensitivity (CRITICAL - Dec 2025)

#### ‚ö†Ô∏è CRITICAL Rule: Lowercase Filenames

**Problem:** Windows is case-insensitive, but Linux (CI/Production) is case-sensitive.

```typescript
// ‚ùå WRONG: PascalCase filenames
src / components / ui / Button.tsx; // Works on Windows
import { Button } from '@/components/ui/button'; // ‚ùå Fails on Linux CI!

// ‚úÖ CORRECT: lowercase filenames
src / components / ui / button.tsx; // Works everywhere
import { Button } from '@/components/ui/button'; // ‚úÖ Works on all OS
```

**Rule Enforcement:**

```
‚úÖ ALWAYS: Use lowercase for ALL filenames
   - button.tsx (not Button.tsx)
   - input.tsx (not Input.tsx)
   - user-card.tsx (kebab-case)

‚úÖ EXPORTS: PascalCase for components
   - export function Button() { }
   - export function UserCard() { }

‚ùå NEVER: Mix case in filename and import
   - File: Button.tsx + Import: '@/button' ‚Üí ‚ùå CI will fail
```

**Naming Conventions:**

```typescript
// Components
button.tsx              ‚Üí export function Button()
user-profile-card.tsx   ‚Üí export function UserProfileCard()

// Utilities
slug.ts                 ‚Üí export function generateSlug()
format.ts               ‚Üí export function formatDate()

// Types/Interfaces
user.ts                 ‚Üí export interface User
product.ts              ‚Üí export interface Product

// API Routes
route.ts                ‚Üí export async function GET()
[id]/route.ts           ‚Üí Dynamic route
```

**Git Commands for Case Change (Windows):**

```bash
# Two-step rename required on Windows
git mv Button.tsx button-temp.tsx
git mv button-temp.tsx button.tsx
```

**Why This Matters:**

- üü¢ **Local (Windows/Mac):** Case-insensitive ‚Üí Works even with wrong case
- üî¥ **CI (Linux/Docker):** Case-sensitive ‚Üí Module not found errors
- üö® **Production:** Same as CI ‚Üí Deploy will fail

**Import Path Verification (CRITICAL):**

```typescript
// ‚ùå WRONG: Case mismatch between file and import
// File: src/components/homepage/sections/Newsletter.tsx
import { Newsletter } from '@/components/homepage/sections/newsletter'; // ‚ùå Fails on Linux!

// ‚úÖ CORRECT: Match exact case
// File: src/components/homepage/sections/newsletter.tsx (lowercase)
import { Newsletter } from '@/components/homepage/sections/newsletter'; // ‚úÖ Works everywhere

// ‚úÖ CORRECT: Or use exact case match
// File: src/components/homepage/sections/Newsletter.tsx (PascalCase)
import { Newsletter } from '@/components/homepage/sections/Newsletter'; // ‚úÖ Works if file is PascalCase
```

**Pre-commit Checklist for Imports:**

1. ‚úÖ Verify import path matches actual filename (case-sensitive)
2. ‚úÖ Use lowercase filenames to avoid issues
3. ‚úÖ Test imports on case-sensitive filesystem (Linux/CI)
4. ‚úÖ Check for `Module not found` errors in build logs

**Recent Case Sensitivity Fixes (Dec 2025):**

- Fixed: `Button.tsx` ‚Üí `button.tsx`
- Fixed: `Input.tsx` ‚Üí `input.tsx`
- Fixed: `Newsletter.tsx` ‚Üí `newsletter.tsx` (import path mismatch)
- Issue: CI build failed with "Module not found: Can't resolve '@/components/homepage/sections/newsletter'"
- Root Cause: Import used lowercase `newsletter` but file was `Newsletter.tsx`
- Lesson: ALWAYS use lowercase filenames AND verify import paths match exactly

---

## 8. Specific Feature Guidelines

### 1Ô∏è‚É£ Author Management (E-E-A-T)

#### Key Rules:

**When working with posts collection:**

```typescript
// Remember authorInfo structure
interface Post {
  authorInfo: {
    authorId: string; // Ref to authors._id
    reviewerId?: string; // For YMYL content
    guestAuthor?: {
      // For non-DB authors
      name: string;
      credentials?: string;
    };
  };
}
```

**Post Count Synchronization:**

```typescript
// When publishing a post:
await posts.updateOne({ _id: postId }, { $set: { status: 'published' } });

// MUST also update author postCount
await authors.updateOne({ _id: new ObjectId(authorId) }, { $inc: { postCount: 1 } });

// When deleting a post:
await posts.deleteOne({ _id: postId });

// MUST also decrement postCount
await authors.updateOne({ _id: new ObjectId(authorId) }, { $inc: { postCount: -1 } });
```

**‚ö†Ô∏è CRITICAL:** Always sync postCount when publishing/unpublishing/deleting posts!

---

### 2Ô∏è‚É£ Image Handling

```typescript
// ‚úÖ ALWAYS use next/image
import Image from 'next/image';

<Image
  src="/images/product.jpg"
  alt="Product name" // REQUIRED
  width={500}
  height={300}
  priority={false} // true for above-fold
/>;

// External images configuration
// File: next.config.ts
export default {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'your-blob-storage.com',
      },
    ],
  },
};
```

---

### 3Ô∏è‚É£ Performance Optimization (NEW - Dec 2025)

#### Dynamic Import for Heavy Libraries:

**When to Use:**

```typescript
// ‚úÖ DO use dynamic import for:
- Libraries > 50KB (Recharts ~150KB, Tiptap ~200KB, Framer Motion ~100KB)
- Components used on specific pages only
- Client-only libraries (charts, editors, animations)
- Features behind user interaction (modals)

// ‚ùå DON'T use for:
- Small libraries < 10KB
- Libraries used on every page
- Critical above-fold content
- Server Components
```

**Pattern:**

```typescript
// Create lazy wrapper: Component.lazy.tsx
import dynamic from 'next/dynamic';
import ComponentSkeleton from './ComponentSkeleton';

const Component = dynamic(() => import('./Component'), {
  loading: () => <ComponentSkeleton />,
  ssr: false, // for client-only libraries
});

export default Component;

// Usage in page:
import Component from '@/components/Component.lazy';
```

**Implemented Examples:**

```typescript
// 1. Recharts (analytics only)
const RevenueChart = dynamic(
  () =>
    import('@/components/admin/analytics/AnalyticsCharts').then((mod) => ({
      default: mod.RevenueChart,
    })),
  { loading: () => <ChartSkeleton />, ssr: false }
);

// 2. Tiptap (editor pages only)
import RichTextEditor from '@/components/admin/RichTextEditor.lazy';

// 3. Framer Motion (modal only)
import SizeGuideModal from '@/components/product/SizeGuideModal.lazy';
```

**Results Achieved:**

- ‚úÖ -44% bundle size on public pages
- ‚úÖ -150KB (Recharts) on non-analytics pages
- ‚úÖ -200KB (Tiptap) on non-editor pages
- ‚úÖ -50KB (Framer) when modal not opened

---

### 4Ô∏è‚É£ Comment System (NEW - Dec 2025)

#### Key Rules:

**Spam Detection:**

```typescript
// ‚úÖ ALWAYS run spam detection on comment submission
import { detectSpam } from '@/lib/utils/spam-detection';

const spamResult = detectSpam({
  content: commentContent,
  authorEmail: email,
  authorName: name,
});

// Set status based on spam score
if (spamResult.isSpam) {
  status = spamResult.score >= 80 ? 'auto-spam' : 'pending';
}
```

**CAPTCHA Integration (Cloudflare Turnstile):**

```typescript
// ‚úÖ ALWAYS require CAPTCHA token for comment submission
import { Turnstile } from '@marsidev/react-turnstile';

// In CommentForm component:
<Turnstile
  siteKey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || '1x00000000000000000000AA'}
  onSuccess={handleCaptchaSuccess}
  onError={handleCaptchaError}
/>

// Submit button disabled until CAPTCHA solved
<Button disabled={!isCaptchaSolved || isSubmitting}>
  G·ª≠i b√¨nh lu·∫≠n
</Button>
```

**Comment Status Flow:**

```typescript
// Status transitions:
'pending' ‚Üí Admin approves ‚Üí 'approved'
'pending' ‚Üí Admin marks spam ‚Üí 'spam'
'auto-spam' ‚Üí Admin approves ‚Üí 'approved'
'approved' ‚Üí Admin deletes ‚Üí Deleted from DB
```

**Nested Comments:**

```typescript
// ‚úÖ Support nested replies via parentId
interface Comment {
  postId: string;
  parentId?: string; // For replies
  // ... other fields
}

// Build nested tree structure
function buildCommentTree(comments: Comment[]): CommentTree {
  // Group by parentId, build hierarchy
}
```

**Admin Moderation:**

```typescript
// ‚úÖ Admin can approve, mark spam, or delete
// Location: src/components/admin/comments/comment-moderation-table.tsx

// Actions:
- Approve: status = 'approved'
- Mark Spam: status = 'spam', update spamScore
- Delete: Remove from DB (cascade to replies)
```

**‚ö†Ô∏è CRITICAL:** Always sanitize comment content to prevent XSS attacks!

---

### 5Ô∏è‚É£ Documentation Management

#### Rules:

**Organization (Updated Dec 2025):**

```
‚úÖ Keep core docs at root: README, @CONTEXT, FLOW (3 files only!)
‚úÖ Keep detailed docs in: docs/ folder
‚úÖ Use logical subfolders:
   - docs/guides/              (User guides)
   - docs/reports/             (Technical reports)
   - docs/reports/performance/ (NEW - Performance reports)
   - docs/archive/             (Historical only)
```

**Redundancy Check:**

```
BEFORE starting major task:
  1. Scan for duplicate/obsolete docs
  2. Recommend deletion of:
     - Old roadmaps
     - Archived meeting notes
     - Outdated status reports
  3. Keep codebase context clean
```

**Priority:**

```
When AI needs context:
  1Ô∏è‚É£ @CONTEXT.md (highest priority)
  2Ô∏è‚É£ FLOW.md (for business logic)
  3Ô∏è‚É£ DATABASE_SCHEMA.md (for data)
  4Ô∏è‚É£ Other specific docs
```

---

## 9. Testing & Quality

### üß™ Unit Testing Strategy (NEW - Dec 2025)

#### Rule: "No Utility Without Test"

**Enforcement:** Any new logic created in `src/lib/utils/*.ts` MUST have an accompanying `.test.ts` file.

**Pattern:**

```
src/lib/utils/
‚îú‚îÄ‚îÄ slug.ts              ‚úÖ Implementation
‚îú‚îÄ‚îÄ slug.test.ts         ‚úÖ Tests (REQUIRED)
‚îú‚îÄ‚îÄ format.ts            ‚úÖ Implementation
‚îî‚îÄ‚îÄ format.test.ts       ‚úÖ Tests (REQUIRED)
```

**Test Framework:** Vitest (preferred) or Jest

**Example:**

```typescript
// src/lib/utils/slug.ts
export function generateSlug(text: string): string {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

// src/lib/utils/slug.test.ts
import { describe, it, expect } from 'vitest';
import { generateSlug } from './slug';

describe('generateSlug', () => {
  it('should convert text to lowercase slug', () => {
    expect(generateSlug('Hello World')).toBe('hello-world');
  });

  it('should handle Vietnamese characters', () => {
    expect(generateSlug('G·∫•u B√¥ng ƒê·∫πp')).toBe('gau-bong-dep');
  });

  it('should remove special characters', () => {
    expect(generateSlug('Hello@#$World!')).toBe('hello-world');
  });

  it('should handle edge cases', () => {
    expect(generateSlug('')).toBe('');
    expect(generateSlug('---')).toBe('');
    expect(generateSlug('a b c')).toBe('a-b-c');
  });
});
```

**Coverage Targets:**

1. **New & Critical Utilities:** **100%** Coverage (Mandatory)

   - Applies to: All new files in `src/lib/utils/` and core logic (payment, auth)
   - Examples: New slug.ts, format.ts, validation helpers
   - Reason: Prevent bugs from day one

2. **Legacy & UI Utilities:** **80%+** Coverage (Recommended)
   - Applies to: Existing non-critical helpers or UI formatting strings
   - Examples: Older formatting functions, display helpers
   - Reason: Balance between quality and effort

**Refined Rule:**

"Any **NEW** logic added to `src/lib/utils/*.ts` MUST target **100% coverage**. For existing legacy utilities, aim for at least 80%."

**When AI Creates Utility:**

1. ‚úÖ Write the utility function
2. ‚úÖ Write the test file immediately
3. ‚úÖ Run tests: `npm run test`
4. ‚úÖ Verify 100% coverage for **new** utility
5. ‚úÖ For legacy utilities, ensure 80%+ coverage

**Benefits:**

- ‚úÖ Prevents regression bugs
- ‚úÖ Documents expected behavior
- ‚úÖ Easier refactoring
- ‚úÖ Higher code confidence

---

### ‚úÖ Pre-Commit Checklist:

```typescript
// Before committing, verify:

1. Type Check
   ‚Üí npm run type-check
   ‚Üí Should pass (or have documented known issues)

2. Lint Check
   ‚Üí npm run lint
   ‚Üí 0 errors (warnings acceptable if documented)

3. Remove Console Logs
   ‚Üí No console.log in production code

4. Unused Imports
   ‚Üí All imports are used

5. TypeScript
   ‚Üí No 'any' types
   ‚Üí All variables properly typed
```

### üéØ Final Vibe Check:

**Before outputting code, ask yourself:**

- [ ] Did I remove ALL unused imports/variables?
- [ ] Did I strictly type ALL variables (no `any`)?
- [ ] Did I mix Server/Client logic incorrectly?
- [ ] Did I add proper error handling?
- [ ] Did I validate all inputs with Zod?
- [ ] Did I check authentication on protected routes?
- [ ] Did I use `next/image` instead of `<img>`?
- [ ] Did I add alt text to all images?
- [ ] Did I follow the patterns in documentation?
- [ ] **Did I verify import paths match filenames (case-sensitive)?**
- [ ] **Did I handle env vars at runtime, not import time?**
- [ ] **Did I make components flexible if used in multiple contexts?**

**If any answer is NO ‚Üí Fix it before submitting!**

---

## 10. Git & Project Management Protocols

### üîí Commit Policy

#### Rule 1: Never Auto-Commit

```
‚ùå AI MUST NOT run git commands automatically
‚ùå Never: git add, git commit, git push, git rebase

‚úÖ Only when user EXPLICITLY asks:
   "commit this"
   "push to GitHub"
   "create a commit"
```

#### Rule 2: Atomic Commits

```
‚úÖ GOOD commit message:
   feat: add coupon system
   fix: resolve hydration error
   docs: update flow.md for checkout

‚ùå BAD commit message:
   update files
   fix bugs
   changes
```

**Pattern:** Conventional Commits

- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation
- `style:` - Formatting
- `refactor:` - Code restructure
- `test:` - Tests
- `chore:` - Maintenance

#### Rule 3: Draft Mode

```
‚ö†Ô∏è All code outputted is considered DRAFT
‚úÖ User MUST review before deployment
‚úÖ AI should not assume code is final
```

#### Rule 4: No Automated Deployment

```
‚ùå AI must NOT initiate deployment
‚ùå Don't mention "auto-deploy" unless asked
‚úÖ Assume CI/CD is user's responsibility
```

#### Rule 5: Execution Lock

```
When user asks for git command:

‚ùå WRONG: Run the command
   git commit -m "..."

‚úÖ CORRECT: Display command for user
   "Please run: git commit -m '...'"
```

#### Rule 6: Commit Message Format

```
Professional + Atomic + Conventional Commit pattern

Example:
docs: update flow.md for new feature

Added comprehensive checkout flow diagram including:
- Mermaid sequence diagram
- Error handling strategies
- Performance metrics
```

---

## üìä QUICK REFERENCE CARD

### Must Do ‚úÖ

| Category            | Rule                                           |
| ------------------- | ---------------------------------------------- |
| **Types**           | No `any`, always define interfaces             |
| **DB**              | Use getCollections(), ObjectId for IDs         |
| **Validation**      | Zod schemas for all inputs                     |
| **Auth**            | Check session on protected routes              |
| **Images**          | Use next/image with alt                        |
| **Imports**         | Remove unused, use `import type`               |
| **Hooks**           | Include all deps in array                      |
| **Components**      | export function pattern                        |
| **Errors**          | Try-catch with proper status codes             |
| **Utilities**       | üÜï Import from src/lib/utils/                  |
| **Performance**     | üÜï Dynamic import heavy libraries              |
| **Server/Client**   | üÜï Justify every 'use client'                  |
| **File Naming**     | üÜï Lowercase filenames (button.tsx)            |
| **Component Props** | üÜï Flexible props for multi-context components |
| **Env Vars**        | üÜï Validate at runtime, not import time        |
| **Import Paths**    | üÜï Verify case-sensitive import paths          |

### Must Not ‚ùå

| Category        | Rule                              |
| --------------- | --------------------------------- |
| **Types**       | Never use `any`                   |
| **Console**     | No console.log in production      |
| **Images**      | No `<img>` tags                   |
| **Client**      | No server imports in 'use client' |
| **Validation**  | Never trust client data           |
| **Commits**     | Never auto-commit without asking  |
| **DB**          | No Mongoose/Prisma patterns       |
| **Secrets**     | Never commit credentials          |
| **File Naming** | üÜï No PascalCase filenames        |

---

## üéØ AI BEHAVIOR REQUIREMENTS

When coding, AI must:

1. ‚úÖ Follow all rules in this file
2. ‚úÖ Reference @CONTEXT.md for architecture
3. ‚úÖ Reference FLOW.md for business logic
4. ‚úÖ Reference DATABASE_SCHEMA.md for schemas
5. ‚úÖ Ask before committing code
6. ‚úÖ Remove unused imports automatically
7. ‚úÖ Use proper TypeScript types
8. ‚úÖ Add error handling
9. ‚úÖ Validate all inputs
10. ‚úÖ Follow established patterns
11. ‚úÖ **Language:** MUST reply in Vietnamese (VI) for all output, regardless of the input language (EN/VN).
12. ‚úÖ **Anti-Lazy Mode:** Do not provide tutorials, guides, or "here is how to do it" explanations. **WRITE THE CODE.** If a file needs modification, output the **FULL, COMPLETE** file content. Never use comments like "// ... rest of code" or "// ... unchanged" unless explicitly requested for a tiny diff.

**Violations of these rules = Code quality failure!**

---

**Rules Version:** 3.7  
**Last Updated:** December 6, 2025 (PLP QA, Social Share, Form Decomposition)  
**Status:** Active & Enforced  
**Compliance:** Mandatory for all AI-generated code

**Recent Updates (Version 3.7):**

- ‚úÖ **Form Decomposition Rule** - B·∫Øt bu·ªôc t√°ch nh·ªè form ph·ª©c t·∫°p, d√πng React Hook Form + Zod cho m·ªçi validation.
- ‚úÖ **Social Share Buttons** - Blog h·ªó tr·ª£ chia s·∫ª ƒëa k√™nh (Facebook, Zalo, Copy link, Clipboard API).
- ‚úÖ **Tech Stack Additions** - Zod, Tiptap editor suite, Cloudflare Turnstile (CAPTCHA).
- ‚úÖ **PLP QA Sync** - ƒê·ªìng b·ªô k·∫øt qu·∫£ ki·ªÉm th·ª≠ PLP v√†o quy t·∫Øc v√† t√†i li·ªáu.

**Previous Updates (Version 3.6):**

- ‚úÖ **Blog System Integration** - NEW: Added Blog System with templates, product linking, reading time, table of contents
- ‚úÖ **Comment System Rules** - NEW: Added Comment System guidelines with spam detection, CAPTCHA (Cloudflare Turnstile), and admin moderation
- ‚úÖ **Tech Stack Updates** - NEW: Added Tiptap, date-fns, Cloudflare Turnstile to tech stack

**Previous Updates (Version 3.5):**

- ‚úÖ **Component Props Flexibility** - CRITICAL: Components used in multiple contexts must support flexible props (HomepageRenderer vs direct usage)
- ‚úÖ **Environment Variables in Build Phase** - CRITICAL: Env vars must be validated at runtime, not import time. Use build phase detection for Vercel/CI compatibility
- ‚úÖ **Import Path Verification** - Enhanced: Verify case-sensitive import paths match actual filenames. Pre-commit checklist for imports

**Previous Updates (Version 3.4):**

- ‚úÖ **Anti-Lazy Mode** - CRITICAL: AI must output FULL, COMPLETE code files. No tutorials or partial snippets.
- ‚úÖ **Full Implementation Protocol** - New 6th Pillar: Always write actionable, copy-pasteable, COMPLETE code.

**Previous Updates (Version 3.3):**

- ‚úÖ **File Naming Convention** - CRITICAL: Lowercase filenames for cross-platform compatibility (button.tsx not Button.tsx)
- ‚úÖ **Vietnamese Language Requirement** - All AI responses MUST be in Vietnamese (VI)
- ‚úÖ **Standardized Error Response** - Strict JSON structure for all API errors
- ‚úÖ **Mandatory Utils Testing** - No utility without .test.ts file
- ‚úÖ **A11y for Icon Buttons** - aria-label requirement for icon-only buttons

**Previous Updates (Version 3.0):**

- ‚úÖ Server Component audit rules (100% compliance)
- ‚úÖ Dynamic import patterns for heavy libraries
- ‚úÖ Centralized utility functions (slug.ts, format.ts)
- ‚úÖ Performance optimization guidelines
- ‚úÖ Updated documentation structure

üéØ **AI: I have read and memorized all rules in this file!**
