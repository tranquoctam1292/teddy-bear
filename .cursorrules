# ğŸ» Teddy Shop - AI Coding Rules & Guidelines

**Project:** Teddy Shop E-commerce Platform  
**Purpose:** Ensure code quality, consistency, and production readiness  
**Enforcement:** AI must follow these rules strictly

---

## ğŸ“‹ Table of Contents

1. [Project Context](#1-project-context)
2. [Core Principles](#2-core-principles)
3. [Documentation Enforcement](#3-documentation-enforcement-mandatory)
4. [QA & Safety Protocols](#4-qa--safety-protocols)
5. [Architecture & Directory](#5-architecture--directory-structure)
6. [Coding Standards](#6-coding-standards)
7. [Specific Features](#7-specific-feature-guidelines)
8. [Testing & Quality](#8-testing--quality)
9. [Git Protocols](#9-git--project-management-protocols)

---

## 1. Project Context

### ğŸ·ï¸ Basic Info

| Property      | Value                                |
| ------------- | ------------------------------------ |
| **Name**      | Teddy Shop E-commerce Platform       |
| **Framework** | Next.js 16 (App Router)              |
| **Frontend**  | React 19, TypeScript 5               |
| **Database**  | MongoDB (Native Driver)              |
| **Auth**      | NextAuth v5                          |
| **Styling**   | Tailwind CSS, Radix UI, Lucide Icons |
| **State**     | Zustand, React Hook Form             |

### ğŸ¯ Key Features

- Author Management (E-E-A-T compliance)
- Blog with Tiptap editor
- Product Management
- SEO Tools (Keywords, Schema.org, Audit)
- Homepage Configuration System (15 sections)

---

## 2. Core Principles

### ğŸ¯ The Five Pillars:

#### 1ï¸âƒ£ Server-Side First

```
Prioritize Server Components by default.
Use 'use client' ONLY when absolutely needed:
  âœ… When: useState, useEffect, event handlers, useRouter, useSession
  âŒ When: Just rendering static content
  âŒ When: Only using window.location.href (use Link instead)

AUDIT RULE (Dec 2025):
  - 100% of pages must justify 'use client' usage
  - If no React hooks used â†’ Must be Server Component
  - Replace window.location.href with Next.js Link
```

#### 2ï¸âƒ£ Clean Architecture

```
Separation of Concerns:
  ğŸ“„ UI components    â†’ src/components/
  ğŸ§  Business logic   â†’ src/lib/
  ğŸ—„ï¸ Data access      â†’ src/lib/db.ts
  âœ… Validation       â†’ src/lib/schemas/
  ğŸ”§ Utility functions â†’ src/lib/utils/

UTILITY EXTRACTION RULE (Dec 2025):
  - Pure functions (no React hooks) â†’ src/lib/utils/
  - Examples: slug.ts, format.ts
  - Never inline formatDate, generateSlug, etc.
  - Reuse centralized utilities
```

#### 3ï¸âƒ£ Strict TypeScript

```
âŒ FORBIDDEN: any type
âœ… REQUIRED: Always define or import interfaces
âœ… USE: unknown for uncertain types
âœ… DEFINE: Proper interfaces for all data
```

#### 4ï¸âƒ£ Security First

```
âœ… Validate ALL inputs with Zod
âœ… Check auth/roles on EVERY protected route
âœ… Never trust client data
âœ… Always recalculate prices server-side
```

#### 5ï¸âƒ£ Performance Optimization

```
BUNDLE SIZE RULES (Dec 2025):
  âœ… Use dynamic imports for heavy libraries (>50KB)
  âœ… Examples: Recharts, Tiptap, Framer Motion
  âœ… Show loading skeletons
  âœ… Set ssr: false for client-only libraries

PATTERN:
  const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
    loading: () => <Skeleton />,
    ssr: false,
  });

TARGET: Keep initial bundle < 250KB
```

---

## 3. Documentation Enforcement (MANDATORY)

### ğŸš¨ CRITICAL RULE:

When performing tasks, AI **MUST** automatically load these documents:

| Task Type                               | Required Document     | Purpose                       |
| --------------------------------------- | --------------------- | ----------------------------- |
| **DB Queries, Schemas, API validation** | `@DATABASE_SCHEMA.md` | Verify fields, types, indexes |
| **Complex business logic**              | `@FLOW.md`            | Follow sequential steps       |
| **Everything else**                     | `@CONTEXT.md`         | Core business rules           |

### ğŸ“– Document Priority:

**Before creating/modifying data:**

1. âœ… Read `DATABASE_SCHEMA.md` â†’ Check schema, field names, indexes
2. âœ… Use correct field types
3. âœ… Follow existing constraints

**Before implementing checkout/order logic:**

1. âœ… Read `FLOW.md` â†’ Follow defined flow
2. âœ… Implement rollback strategies
3. âœ… Follow state transitions

**Always:**

- âœ… Reference `@CONTEXT.md` for architecture decisions
- âœ… Follow patterns defined in documentation

---

## 4. QA & Safety Protocols

### ğŸ›¡ï¸ Zero-Tolerance Linter Rules

#### âŒ Rule 1: No Unused Variables

```typescript
// âŒ WRONG: Unused import
import { UserIcon, HomeIcon } from 'lucide-react';
export function Header() {
  return <UserIcon />; // HomeIcon not used!
}

// âœ… CORRECT: Remove unused
import { UserIcon } from 'lucide-react';
export function Header() {
  return <UserIcon />;
}
```

**Action:** Remove ALL unused variables/imports during refactoring

---

#### âŒ Rule 2: No 'any' Type

```typescript
// âŒ STRICTLY FORBIDDEN
function processData(data: any) {
  return data.something;
}

// âœ… CORRECT: Define proper interface
interface User {
  id: string;
  name: string;
}

function processData(data: User) {
  return data.name;
}

// âœ… ACCEPTABLE: Use unknown for uncertain types
function processData(data: unknown) {
  if (typeof data === 'object' && data !== null) {
    // Type guard
  }
}
```

**Rule:** NEVER use `any`. Use `unknown` or define interface.

---

#### âŒ Rule 3: Exhaustive Dependencies

```typescript
// âŒ WRONG: Missing dependency
useEffect(() => {
  fetchData(userId);
}, []); // userId not in deps!

// âœ… CORRECT: Include all deps
useEffect(() => {
  fetchData(userId);
}, [userId]);

// âŒ NEVER suppress warnings
useEffect(() => {
  fetchData(userId);
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, []); // BAD PRACTICE!
```

**Rule:** Always include ALL variables used inside hooks in dependency array.

---

#### âŒ Rule 4: No Console Logs

```typescript
// âŒ WRONG: Leave console.log
export function Component() {
  console.log('Debug info');
  return <div>Hello</div>;
}

// âœ… CORRECT: Remove or use proper logging
export function Component() {
  // console.log removed
  return <div>Hello</div>;
}

// âœ… ACCEPTABLE: Proper error logging
try {
  // ...
} catch (error) {
  console.error('Critical error:', error); // OK for errors
}
```

**Rule:** No `console.log` in production code. Use proper error logging if needed.

---

### ğŸ—ï¸ Build Safety (Server vs Client)

#### Import Guards

```typescript
// âŒ WRONG: Import server code in client component
'use client';

import { getCollections } from '@/lib/db'; // Server-only!

export function ClientComponent() {
  // This will fail!
}

// âœ… CORRECT: Call API instead
('use client');

export function ClientComponent() {
  useEffect(() => {
    fetch('/api/data').then((r) => r.json());
  }, []);
}
```

**Rule:** NEVER import server-only code (db.ts, env secrets) in 'use client' files.

---

#### Type Imports

```typescript
// âœ… CORRECT: Use 'import type' for types only
import type { User } from '@/lib/types/user';
import { formatUser } from '@/lib/utils/user';

// âŒ AVOID: Regular import for types
import { User } from '@/lib/types/user'; // May cause side effects
```

**Rule:** Use `import type { }` when importing interfaces/types only.

---

#### Image Optimization

```typescript
// âŒ WRONG: Standard img tag
<img src="/photo.jpg" />;

// âœ… CORRECT: Next.js Image component
import Image from 'next/image';

<Image
  src="/photo.jpg"
  alt="Product photo" // Alt REQUIRED
  width={500}
  height={300}
/>;
```

**Rules:**

- âœ… ALWAYS use `next/image`
- âœ… ALWAYS provide meaningful `alt` prop
- âŒ NEVER use `<img>` tag (unless raw HTML)

---

## 5. Architecture & Directory Structure

```
src/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (shop)/              # ğŸ›ï¸ Public pages (with Header/Footer)
â”‚   â”‚   â”œâ”€â”€ page.tsx         # Homepage (dynamic from config)
â”‚   â”‚   â”œâ”€â”€ products/        # Product listing & detail
â”‚   â”‚   â”œâ”€â”€ cart/            # Shopping cart
â”‚   â”‚   â”œâ”€â”€ checkout/        # Checkout process
â”‚   â”‚   â””â”€â”€ (content)/       # Blog, About, Store
â”‚   â”‚
â”‚   â”œâ”€â”€ admin/               # ğŸ”’ Protected admin (Sidebar only)
â”‚   â”‚   â”œâ”€â”€ authors/         # Author CRUD
â”‚   â”‚   â”œâ”€â”€ posts/           # Blog CRUD
â”‚   â”‚   â”œâ”€â”€ products/        # Product CRUD
â”‚   â”‚   â”œâ”€â”€ homepage/        # Homepage config
â”‚   â”‚   â”œâ”€â”€ seo/             # SEO tools
â”‚   â”‚   â””â”€â”€ settings/        # System settings
â”‚   â”‚
â”‚   â””â”€â”€ api/                 # ğŸ”Œ API Routes (Route Handlers)
â”‚       â”œâ”€â”€ admin/           # Admin-only endpoints
â”‚       â”œâ”€â”€ authors/         # Public author API
â”‚       â”œâ”€â”€ homepage/        # Public homepage API
â”‚       â””â”€â”€ checkout/        # Checkout API
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                  # âš›ï¸ Atomic components (Shadcn style)
â”‚   â”‚   â”œâ”€â”€ button.tsx       # Reuse these!
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ table.tsx
â”‚   â”‚   â””â”€â”€ ... (11 total)
â”‚   â”‚
â”‚   â”œâ”€â”€ admin/               # ğŸ› ï¸ Admin widgets
â”‚   â”‚   â”œâ”€â”€ AuthorBoxWidget.tsx
â”‚   â”‚   â”œâ”€â”€ RowActions.tsx
â”‚   â”‚   â””â”€â”€ homepage/        # Homepage builder
â”‚   â”‚
â”‚   â”œâ”€â”€ blog/                # ğŸ“ Blog components
â”‚   â”‚   â”œâ”€â”€ AuthorBox.tsx
â”‚   â”‚   â””â”€â”€ ReviewerBox.tsx
â”‚   â”‚
â”‚   â””â”€â”€ homepage/            # ğŸ  Homepage sections
â”‚       â”œâ”€â”€ HomepageRenderer.tsx
â”‚       â””â”€â”€ sections/        # 15 section types
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db.ts                # ğŸ—„ï¸ MongoDB connection
â”‚   â”œâ”€â”€ auth.ts              # ğŸ” NextAuth config
â”‚   â”œâ”€â”€ types/               # TypeScript interfaces
â”‚   â”œâ”€â”€ schemas/             # Zod validation
â”‚   â”œâ”€â”€ utils/               # ğŸ†• Utility functions
â”‚   â”‚   â”œâ”€â”€ slug.ts          # generateSlug(), isValidSlug()
â”‚   â”‚   â””â”€â”€ format.ts        # formatDate(), formatCurrency()
â”‚   â”œâ”€â”€ payment/             # Payment gateways
â”‚   â”œâ”€â”€ stock/               # Stock management
â”‚   â””â”€â”€ email/               # Email service
â”‚
â””â”€â”€ store/
    â””â”€â”€ useCartStore.ts      # Zustand cart state
```

### ğŸ“ Key Directories:

| Directory           | Purpose           | Pattern                      |
| ------------------- | ----------------- | ---------------------------- |
| `src/app/(shop)`    | Public pages      | Server Components preferred  |
| `src/app/admin`     | Admin dashboard   | Authentication required      |
| `src/app/api`       | REST endpoints    | Return NextResponse.json     |
| `src/components/ui` | Reusable UI       | Prefer reusing over creating |
| `src/lib`           | Business logic    | No React code                |
| `src/lib/schemas`   | Validation        | Zod schemas                  |
| `src/lib/utils`     | ğŸ†• Pure functions | slug, format, etc.           |

---

## 6. Coding Standards

### 1ï¸âƒ£ Database Access (CRITICAL)

#### âœ… CORRECT Pattern: Repository via getCollections()

```typescript
import { getCollections } from '@/lib/db';
import { ObjectId } from 'mongodb';

async function getUser(id: string) {
  // Step 1: Get collections
  const { users, posts } = await getCollections();

  // Step 2: Validate ID
  if (!ObjectId.isValid(id)) {
    throw new Error('Invalid ID');
  }

  // Step 3: Query with ObjectId
  const user = await users.findOne({
    _id: new ObjectId(id),
  });

  return user;
}
```

#### âŒ FORBIDDEN Patterns:

```typescript
// âŒ DON'T: Mongoose Models
const user = await User.findOne({ _id: id });

// âŒ DON'T: Prisma
const user = await prisma.user.findUnique({ where: { id } });

// âŒ DON'T: Query without ObjectId conversion
const user = await users.findOne({ _id: id }); // String won't work!
```

#### ğŸ”‘ ID Handling Rules:

```typescript
// Always validate before converting
if (!ObjectId.isValid(id)) {
  return NextResponse.json({ error: 'Invalid ID' }, { status: 400 });
}

// Then convert for query
const doc = await collection.findOne({
  _id: new ObjectId(id),
});
```

---

### 2ï¸âƒ£ API Routes (Next.js Route Handlers)

#### Pattern:

```typescript
// Location: src/app/api/[feature]/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { getCollections } from '@/lib/db';
import { schemaName } from '@/lib/schemas/feature';

export async function GET(request: NextRequest) {
  try {
    // 1. Check authentication (if protected)
    const session = await auth();
    if (!session?.user || session.user.role !== 'admin') {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 2. Get data
    const { collection } = await getCollections();
    const data = await collection.find({}).toArray();

    // 3. Return JSON
    return NextResponse.json({ data }, { status: 200 });
  } catch (error) {
    // 4. Error handling
    console.error('Error:', error);
    return NextResponse.json({ error: 'Failed to fetch data' }, { status: 500 });
  }
}

export async function POST(request: NextRequest) {
  try {
    // 1. Auth check
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 2. Parse body
    const body = await request.json();

    // 3. Validate with Zod
    const validatedData = schemaName.parse(body);

    // 4. Process & save
    const { collection } = await getCollections();
    const result = await collection.insertOne(validatedData);

    // 5. Return success
    return NextResponse.json(
      { message: 'Created successfully', id: result.insertedId },
      { status: 201 }
    );
  } catch (error) {
    if (error.name === 'ZodError') {
      return NextResponse.json({ error: 'Invalid data', details: error }, { status: 400 });
    }
    return NextResponse.json({ error: 'Server error' }, { status: 500 });
  }
}
```

#### Status Codes:

| Code | Meaning               | When to Use                 |
| ---- | --------------------- | --------------------------- |
| 200  | OK                    | Successful GET/PATCH        |
| 201  | Created               | Successful POST             |
| 400  | Bad Request           | Invalid input               |
| 401  | Unauthorized          | Not logged in               |
| 403  | Forbidden             | Logged in but no permission |
| 404  | Not Found             | Resource doesn't exist      |
| 500  | Internal Server Error | Server/DB error             |

---

#### ğŸ”’ Standardized Error Responses (NEW - Dec 2025)

**Rule:** All API Routes MUST return errors in a strict JSON structure to prevent inconsistent error objects.

**Type Definition:**

```typescript
type APIErrorResponse = {
  success: false;
  error: {
    code: string; // e.g., 'VALIDATION_ERROR', 'AUTH_ERROR', 'NOT_FOUND'
    message: string; // Human-readable message
    details?: unknown; // Zod error details or additional context
  };
};

type APISuccessResponse<T> = {
  success: true;
  data: T;
  message?: string;
};
```

**Error Codes:**

| Code               | Status | Usage                  |
| ------------------ | ------ | ---------------------- |
| `VALIDATION_ERROR` | 400    | Zod validation failed  |
| `AUTH_ERROR`       | 401    | Not authenticated      |
| `FORBIDDEN`        | 403    | No permission          |
| `NOT_FOUND`        | 404    | Resource doesn't exist |
| `CONFLICT`         | 409    | Duplicate/conflict     |
| `SERVER_ERROR`     | 500    | Internal error         |

**Examples:**

```typescript
// âœ… CORRECT: Validation error
return NextResponse.json(
  {
    success: false,
    error: {
      code: 'VALIDATION_ERROR',
      message: 'Invalid input data',
      details: error.flatten(),
    },
  },
  { status: 400 }
);

// âœ… CORRECT: Authentication error
return NextResponse.json(
  {
    success: false,
    error: {
      code: 'AUTH_ERROR',
      message: 'Authentication required',
    },
  },
  { status: 401 }
);

// âœ… CORRECT: Not found
return NextResponse.json(
  {
    success: false,
    error: {
      code: 'NOT_FOUND',
      message: 'Resource not found',
    },
  },
  { status: 404 }
);

// âœ… CORRECT: Success response
return NextResponse.json(
  {
    success: true,
    data: { user },
    message: 'User created successfully',
  },
  { status: 201 }
);

// âŒ WRONG: Inconsistent error format
return NextResponse.json({ error: 'Something went wrong' }, { status: 500 });

// âŒ WRONG: No success field
return NextResponse.json({ data: user }, { status: 200 });
```

**Benefits:**

- âœ… Consistent error handling across all API routes
- âœ… Better client-side error detection (`if (!response.success)`)
- âœ… Easier debugging with error codes
- âœ… Type-safe error responses

---

### 3ï¸âƒ£ Authentication & Authorization

```typescript
// Import auth
import { auth } from '@/lib/auth';

// Check at START of every protected route
export async function POST(request: NextRequest) {
  // Step 1: Get session
  const session = await auth();

  // Step 2: Check authentication
  if (!session?.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Step 3: Check role (if admin-only)
  if (session.user.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  // Proceed with logic...
}
```

**Rules:**

- âœ… Check at the START of route
- âœ… Check both user AND role
- âœ… Return proper status codes

---

### 4ï¸âƒ£ Component Implementation

#### Function Components (Preferred):

```typescript
// âœ… CORRECT: Named export function
interface Props {
  name: string;
  age: number;
}

export function UserCard({ name, age }: Props) {
  return (
    <div>
      {name} - {age}
    </div>
  );
}

// âŒ AVOID: const with React.FC
export const UserCard: React.FC<Props> = ({ name, age }) => {
  return (
    <div>
      {name} - {age}
    </div>
  );
};
```

#### Props Interface:

```typescript
// âœ… ALWAYS define props interface ABOVE component
interface ButtonProps {
  label: string;
  onClick: () => void;
  variant?: 'primary' | 'secondary';
}

export function Button({ label, onClick, variant = 'primary' }: ButtonProps) {
  // Component logic
}
```

#### Icons:

```typescript
// âœ… Use lucide-react
import { UserIcon, ShoppingCart, Heart } from 'lucide-react';

<UserIcon className="w-5 h-5" />;
```

#### Styling:

```typescript
// âœ… Tailwind classes via className
<div className="flex items-center gap-4 p-6 bg-white rounded-lg shadow-md">

// âœ… Use cn() for conditional classes
import { cn } from '@/lib/utils';

<div className={cn(
  'base-class',
  isActive && 'active-class',
  variant === 'primary' && 'primary-class'
)}>
```

---

#### Accessibility (A11y):

**Rule:** Icon-only buttons MUST have an `aria-label` for screen readers.

```typescript
// âŒ WRONG: Icon button without label
<Button size="icon">
  <TrashIcon />
</Button>

// âœ… CORRECT: Accessible icon button
<Button size="icon" aria-label="Delete item">
  <TrashIcon />
</Button>

// âœ… CORRECT: Icon with text (no aria-label needed)
<Button>
  <TrashIcon className="w-4 h-4 mr-2" />
  Delete
</Button>
```

**Additional A11y Rules:**

- âœ… All images MUST have alt text
- âœ… Form inputs MUST have labels
- âœ… Interactive elements MUST be keyboard accessible
- âœ… Color contrast MUST meet WCAG 2.1 AA standards

---

### 5ï¸âƒ£ Utility Functions (NEW - Dec 2025)

#### Centralized Utilities:

**Location:** `src/lib/utils/`

**Pattern:**

```typescript
// âŒ WRONG: Inline utility in component
export function PostEditor() {
  const generateSlug = (text: string) => {
    return text.toLowerCase()...
  };
  // Component logic
}

// âœ… CORRECT: Import from centralized utils
import { generateSlug } from '@/lib/utils/slug';

export function PostEditor() {
  // Component logic - just use generateSlug()
}
```

**Available Utilities:**

**A. Slug Generation (`src/lib/utils/slug.ts`):**

```typescript
import { generateSlug, isValidSlug } from '@/lib/utils/slug';

generateSlug('Hello World'); // â†’ 'hello-world'
isValidSlug('hello-world'); // â†’ true
```

**B. Formatting (`src/lib/utils/format.ts`):**

```typescript
import { formatDate, formatCurrency, formatFileSize } from '@/lib/utils/format';

formatDate(new Date()); // â†’ '04/12/2025 14:30'
formatCurrency(100000); // â†’ '100.000 â‚«'
formatFileSize(1024); // â†’ '1 KB'
```

**Rule:** ALWAYS import utilities. NEVER duplicate logic.

---

### 6ï¸âƒ£ Date & Time

```typescript
// âœ… Use centralized format utility
import { formatDate } from '@/lib/utils/format';

formatDate(new Date()); // Vietnamese format
formatDate(date, 'en-US'); // Custom locale

// âœ… Store as Date objects in MongoDB
const document = {
  createdAt: new Date(), // âœ… Date object
  updatedAt: new Date(),
};

// âŒ NEVER store as strings
const document = {
  createdAt: '2025-12-04', // âŒ WRONG!
};
```

---

## 7. Specific Feature Guidelines

### 1ï¸âƒ£ Author Management (E-E-A-T)

#### Key Rules:

**When working with posts collection:**

```typescript
// Remember authorInfo structure
interface Post {
  authorInfo: {
    authorId: string; // Ref to authors._id
    reviewerId?: string; // For YMYL content
    guestAuthor?: {
      // For non-DB authors
      name: string;
      credentials?: string;
    };
  };
}
```

**Post Count Synchronization:**

```typescript
// When publishing a post:
await posts.updateOne({ _id: postId }, { $set: { status: 'published' } });

// MUST also update author postCount
await authors.updateOne({ _id: new ObjectId(authorId) }, { $inc: { postCount: 1 } });

// When deleting a post:
await posts.deleteOne({ _id: postId });

// MUST also decrement postCount
await authors.updateOne({ _id: new ObjectId(authorId) }, { $inc: { postCount: -1 } });
```

**âš ï¸ CRITICAL:** Always sync postCount when publishing/unpublishing/deleting posts!

---

### 2ï¸âƒ£ Image Handling

```typescript
// âœ… ALWAYS use next/image
import Image from 'next/image';

<Image
  src="/images/product.jpg"
  alt="Product name" // REQUIRED
  width={500}
  height={300}
  priority={false} // true for above-fold
/>;

// External images configuration
// File: next.config.ts
export default {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'your-blob-storage.com',
      },
    ],
  },
};
```

---

### 3ï¸âƒ£ Performance Optimization (NEW - Dec 2025)

#### Dynamic Import for Heavy Libraries:

**When to Use:**

```typescript
// âœ… DO use dynamic import for:
- Libraries > 50KB (Recharts ~150KB, Tiptap ~200KB, Framer Motion ~100KB)
- Components used on specific pages only
- Client-only libraries (charts, editors, animations)
- Features behind user interaction (modals)

// âŒ DON'T use for:
- Small libraries < 10KB
- Libraries used on every page
- Critical above-fold content
- Server Components
```

**Pattern:**

```typescript
// Create lazy wrapper: Component.lazy.tsx
import dynamic from 'next/dynamic';
import ComponentSkeleton from './ComponentSkeleton';

const Component = dynamic(() => import('./Component'), {
  loading: () => <ComponentSkeleton />,
  ssr: false, // for client-only libraries
});

export default Component;

// Usage in page:
import Component from '@/components/Component.lazy';
```

**Implemented Examples:**

```typescript
// 1. Recharts (analytics only)
const RevenueChart = dynamic(
  () =>
    import('@/components/admin/analytics/AnalyticsCharts').then((mod) => ({
      default: mod.RevenueChart,
    })),
  { loading: () => <ChartSkeleton />, ssr: false }
);

// 2. Tiptap (editor pages only)
import RichTextEditor from '@/components/admin/RichTextEditor.lazy';

// 3. Framer Motion (modal only)
import SizeGuideModal from '@/components/product/SizeGuideModal.lazy';
```

**Results Achieved:**

- âœ… -44% bundle size on public pages
- âœ… -150KB (Recharts) on non-analytics pages
- âœ… -200KB (Tiptap) on non-editor pages
- âœ… -50KB (Framer) when modal not opened

---

### 4ï¸âƒ£ Documentation Management

#### Rules:

**Organization (Updated Dec 2025):**

```
âœ… Keep core docs at root: README, @CONTEXT, FLOW (3 files only!)
âœ… Keep detailed docs in: docs/ folder
âœ… Use logical subfolders:
   - docs/guides/              (User guides)
   - docs/reports/             (Technical reports)
   - docs/reports/performance/ (NEW - Performance reports)
   - docs/archive/             (Historical only)
```

**Redundancy Check:**

```
BEFORE starting major task:
  1. Scan for duplicate/obsolete docs
  2. Recommend deletion of:
     - Old roadmaps
     - Archived meeting notes
     - Outdated status reports
  3. Keep codebase context clean
```

**Priority:**

```
When AI needs context:
  1ï¸âƒ£ @CONTEXT.md (highest priority)
  2ï¸âƒ£ FLOW.md (for business logic)
  3ï¸âƒ£ DATABASE_SCHEMA.md (for data)
  4ï¸âƒ£ Other specific docs
```

---

## 8. Testing & Quality

### ğŸ§ª Unit Testing Strategy (NEW - Dec 2025)

#### Rule: "No Utility Without Test"

**Enforcement:** Any new logic created in `src/lib/utils/*.ts` MUST have an accompanying `.test.ts` file.

**Pattern:**

```
src/lib/utils/
â”œâ”€â”€ slug.ts              âœ… Implementation
â”œâ”€â”€ slug.test.ts         âœ… Tests (REQUIRED)
â”œâ”€â”€ format.ts            âœ… Implementation
â””â”€â”€ format.test.ts       âœ… Tests (REQUIRED)
```

**Test Framework:** Vitest (preferred) or Jest

**Example:**

```typescript
// src/lib/utils/slug.ts
export function generateSlug(text: string): string {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

// src/lib/utils/slug.test.ts
import { describe, it, expect } from 'vitest';
import { generateSlug } from './slug';

describe('generateSlug', () => {
  it('should convert text to lowercase slug', () => {
    expect(generateSlug('Hello World')).toBe('hello-world');
  });

  it('should handle Vietnamese characters', () => {
    expect(generateSlug('Gáº¥u BÃ´ng Äáº¹p')).toBe('gau-bong-dep');
  });

  it('should remove special characters', () => {
    expect(generateSlug('Hello@#$World!')).toBe('hello-world');
  });

  it('should handle edge cases', () => {
    expect(generateSlug('')).toBe('');
    expect(generateSlug('---')).toBe('');
    expect(generateSlug('a b c')).toBe('a-b-c');
  });
});
```

**Coverage Targets:**

1. **New & Critical Utilities:** **100%** Coverage (Mandatory)

   - Applies to: All new files in `src/lib/utils/` and core logic (payment, auth)
   - Examples: New slug.ts, format.ts, validation helpers
   - Reason: Prevent bugs from day one

2. **Legacy & UI Utilities:** **80%+** Coverage (Recommended)
   - Applies to: Existing non-critical helpers or UI formatting strings
   - Examples: Older formatting functions, display helpers
   - Reason: Balance between quality and effort

**Refined Rule:**

"Any **NEW** logic added to `src/lib/utils/*.ts` MUST target **100% coverage**. For existing legacy utilities, aim for at least 80%."

**When AI Creates Utility:**

1. âœ… Write the utility function
2. âœ… Write the test file immediately
3. âœ… Run tests: `npm run test`
4. âœ… Verify 100% coverage for **new** utility
5. âœ… For legacy utilities, ensure 80%+ coverage

**Benefits:**

- âœ… Prevents regression bugs
- âœ… Documents expected behavior
- âœ… Easier refactoring
- âœ… Higher code confidence

---

### âœ… Pre-Commit Checklist:

```typescript
// Before committing, verify:

1. Type Check
   â†’ npm run type-check
   â†’ Should pass (or have documented known issues)

2. Lint Check
   â†’ npm run lint
   â†’ 0 errors (warnings acceptable if documented)

3. Remove Console Logs
   â†’ No console.log in production code

4. Unused Imports
   â†’ All imports are used

5. TypeScript
   â†’ No 'any' types
   â†’ All variables properly typed
```

### ğŸ¯ Final Vibe Check:

**Before outputting code, ask yourself:**

- [ ] Did I remove ALL unused imports/variables?
- [ ] Did I strictly type ALL variables (no `any`)?
- [ ] Did I mix Server/Client logic incorrectly?
- [ ] Did I add proper error handling?
- [ ] Did I validate all inputs with Zod?
- [ ] Did I check authentication on protected routes?
- [ ] Did I use `next/image` instead of `<img>`?
- [ ] Did I add alt text to all images?
- [ ] Did I follow the patterns in documentation?

**If any answer is NO â†’ Fix it before submitting!**

---

## 9. Git & Project Management Protocols

### ğŸ”’ Commit Policy

#### Rule 1: Never Auto-Commit

```
âŒ AI MUST NOT run git commands automatically
âŒ Never: git add, git commit, git push, git rebase

âœ… Only when user EXPLICITLY asks:
   "commit this"
   "push to GitHub"
   "create a commit"
```

#### Rule 2: Atomic Commits

```
âœ… GOOD commit message:
   feat: add coupon system
   fix: resolve hydration error
   docs: update flow.md for checkout

âŒ BAD commit message:
   update files
   fix bugs
   changes
```

**Pattern:** Conventional Commits

- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation
- `style:` - Formatting
- `refactor:` - Code restructure
- `test:` - Tests
- `chore:` - Maintenance

#### Rule 3: Draft Mode

```
âš ï¸ All code outputted is considered DRAFT
âœ… User MUST review before deployment
âœ… AI should not assume code is final
```

#### Rule 4: No Automated Deployment

```
âŒ AI must NOT initiate deployment
âŒ Don't mention "auto-deploy" unless asked
âœ… Assume CI/CD is user's responsibility
```

#### Rule 5: Execution Lock

```
When user asks for git command:

âŒ WRONG: Run the command
   git commit -m "..."

âœ… CORRECT: Display command for user
   "Please run: git commit -m '...'"
```

#### Rule 6: Commit Message Format

```
Professional + Atomic + Conventional Commit pattern

Example:
docs: update flow.md for new feature

Added comprehensive checkout flow diagram including:
- Mermaid sequence diagram
- Error handling strategies
- Performance metrics
```

---

## ğŸ“Š QUICK REFERENCE CARD

### Must Do âœ…

| Category          | Rule                                   |
| ----------------- | -------------------------------------- |
| **Types**         | No `any`, always define interfaces     |
| **DB**            | Use getCollections(), ObjectId for IDs |
| **Validation**    | Zod schemas for all inputs             |
| **Auth**          | Check session on protected routes      |
| **Images**        | Use next/image with alt                |
| **Imports**       | Remove unused, use `import type`       |
| **Hooks**         | Include all deps in array              |
| **Components**    | export function pattern                |
| **Errors**        | Try-catch with proper status codes     |
| **Utilities**     | ğŸ†• Import from src/lib/utils/          |
| **Performance**   | ğŸ†• Dynamic import heavy libraries      |
| **Server/Client** | ğŸ†• Justify every 'use client'          |

### Must Not âŒ

| Category       | Rule                              |
| -------------- | --------------------------------- |
| **Types**      | Never use `any`                   |
| **Console**    | No console.log in production      |
| **Images**     | No `<img>` tags                   |
| **Client**     | No server imports in 'use client' |
| **Validation** | Never trust client data           |
| **Commits**    | Never auto-commit without asking  |
| **DB**         | No Mongoose/Prisma patterns       |
| **Secrets**    | Never commit credentials          |

---

## ğŸ¯ AI BEHAVIOR REQUIREMENTS

When coding, AI must:

1. âœ… Follow all rules in this file
2. âœ… Reference @CONTEXT.md for architecture
3. âœ… Reference FLOW.md for business logic
4. âœ… Reference DATABASE_SCHEMA.md for schemas
5. âœ… Ask before committing code
6. âœ… Remove unused imports automatically
7. âœ… Use proper TypeScript types
8. âœ… Add error handling
9. âœ… Validate all inputs
10. âœ… Follow established patterns
11. âœ… **Language:** MUST reply in Vietnamese (VI) for all output, regardless of the input language (EN/VN).

**Violations of these rules = Code quality failure!**

---

**Rules Version:** 3.2  
**Last Updated:** December 4, 2025 (Language Policy Update)  
**Status:** Active & Enforced  
**Compliance:** Mandatory for all AI-generated code

**Recent Updates (Version 3.2):**

- âœ… **Vietnamese Language Requirement** - All AI responses MUST be in Vietnamese (VI)
- âœ… **Standardized Error Response** - Strict JSON structure for all API errors
- âœ… **Mandatory Utils Testing** - No utility without .test.ts file
- âœ… **A11y for Icon Buttons** - aria-label requirement for icon-only buttons

**Previous Updates (Version 3.0):**

- âœ… Server Component audit rules (100% compliance)
- âœ… Dynamic import patterns for heavy libraries
- âœ… Centralized utility functions (slug.ts, format.ts)
- âœ… Performance optimization guidelines
- âœ… Updated documentation structure

ğŸ¯ **AI: I have read and memorized all rules in this file!**
